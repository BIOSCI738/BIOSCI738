## Linear mixed-effect models (LMMs)

**Recall:** Blocking helps control variability by making treatment groups more alike. Experimental units are divided into subsets (called blocks) so that units within the same block are more similar than units from different subsets or blocks. Blocking is a technique for dealing with nuisance factors. A nuisance factor is a factor that has some effect on the response, but is of no interest (e.g., age class).

**Fixed effects** are terms (parameters) in a statistical model which are fixed, or non-random, quantities (e.g., *treatment* group's mean response). For the same *treatment*, we expect this quantity to be the same from experiment to experiment.

**Random effects** are terms (parameters) in a statistical model which are considered as random quantities or variables (e.g., block id). Specifically, terms whose levels are a representative sample from a population, and where the variance of the population is of interest should be allocated as random. Setting a block as a random effect allows us to infer variation between blocks as well as the variation between experimental units within blocks.

**Key idea:** Partition known sources of variation which are unimportant to key scientific question(s) to improve precision of comparisons between treatment means.

### Fixed or Random effects???

![](https://1.bp.blogspot.com/-9PUW42GjR0U/WX1PQagQNXI/AAAAAAAAIoo/sIs8WyGSNFg0PbV_koT9Bgery_7VuKIPgCLcBGAs/s1600/1taixn.jpg)

### A Randomised Controlled Block Design (RCBD)

![](img/rcbd.png)

#### Ignoring an effect

```{r}
library(tidyverse)
rcbd <- read_csv("https://raw.githubusercontent.com/STATS-UOA/databunker/master/data/rcbd.csv")
```

```{r}
## Note: Run should be a factor
rcbd$Run <- as.factor(rcbd$Run)
rcbd
```

**One-way vs two-way...**

```{r}
anova(lm(logAUC4 ~ Surgery, data = rcbd))
```


```{r}
lm2 <- lm(logAUC4 ~ Run + Surgery, data = rcbd)
anova(lm2)
```
**Always check assumptions**

```{r}
gglm::gglm(lm2)
```

### Analysis using `lmer()` from `lme4`

```{r, echo = FALSE}
rcbd %>%
  ggplot(aes(x = Surgery, y = logAUC8)) +
  geom_boxplot()
```

```{r}
lmer_mod <- lmerTest::lmer(logAUC8 ~ Surgery + (1|Run), data = rcbd)
summary(lmer_mod)
```
Now what about the *Random effects*

We have two variance components
  
  + Between Groups (Runs) $\hat{\sigma^2}_{\text{Run}}$ = 1.479
  + Within Runs (between observations) $\hat{\sigma_2}$ = 1.447
  
Note that `aov()` presents the same information, but in a different way:

```{r}
summary(aov(logAUC8 ~ Surgery + Error(Run), data = rcbd))
```

 + Within Runs (Residuals) $\hat{\sigma}_2$ = 1.447 (*same as `lmer`*)
 + Between Run variance = $\hat{\sigma}^2$ +  $3\:\hat{\sigma}^2_{\text{Run}}$ so $\hat{\sigma}^2_{\text{Run}} = \frac{5.883 - \hat{\sigma}^2 }{3} = \frac{5.883 - 1.447}{3} = 1.479$

## Split-plot and repeated measures designs

**Recall the diabetic and healthy male Wistar rats...**

![](img/factorial_crd.png)

**BUT** what about

![](img/split-plot.png)


```{r}
split_plot <-  read_csv("https://raw.githubusercontent.com/STATS-UOA/databunker/master/data/split_plot.csv")
split_plot
```

```{r}
## recall we need to set factors
split_plot$Animal <- factor(split_plot$Animal)
split_plot$Sample <- factor(split_plot$Sample)
split_plot
```

### Using `aov()`

```{r}
sp_aov <- aov(logAUC ~ Disease*Organ + Error(Animal/Sample), data = split_plot)
summary(sp_aov)
```

### Using `lmer()` (from `lmeTest` and `lmer4`) and `predictmeans()`

```{r}
library(lmerTest) ## MUST LOAD THIS
sp_lmer <- lmerTest::lmer(logAUC ~ Disease*Organ + (1|Animal), data = split_plot) ## MUST SPECIFY WHICH PACKAGE
anova(sp_lmer,type = 2)
```

```{r, eval = FALSE}
library(lme4)
library(predictmeans)
sp_lmer4 <- lme4::lmer(logAUC ~ Disease*Organ + (1|Animal), data = split_plot) ## MUST SPECIFY WHICH PACKAGE
sp_predmeans <- predictmeans(sp_lmer4,modelterm = "Disease:Organ", pairwise = TRUE, plot = FALSE)
sp_predmeans
```


## Analysis of a repeated measures design

We have (*balanced*) data with the same number of observations on each rat at the same time points.

### The data

```{r}
liver <- read_csv("https://raw.githubusercontent.com/STATS-UOA/databunker/master/data/repeated_measures_liver.csv")
```

```{r}
## change time to factor
liver$Time <- as.factor(liver$Time)
glimpse(liver)
```


### Visualise

**plot data**

```{r}
ggplot(liver, aes(x = Time, y = Glucose, color = Treatment, group = Animal)) +
  geom_line(size = 1) + 
  geom_point(shape = 1) +
  theme_bw()
```

**plot group means**

```{r}
liver_means <- liver %>% group_by(Time,Treatment) %>%
  summarise(Glucose = mean(Glucose))
ggplot(liver_means, aes(x = Time, y = Glucose, color = Treatment, group = Treatment)) +
  geom_line(size = 1) + 
  geom_point(shape = 1) +
  theme_bw()
```

**linear?**

```{r}
ggplot(liver_means, aes(x = Time, y = Glucose, color = Treatment, group = Treatment)) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_point(shape = 1) +
  theme_bw()
```

### Using `aov()`

```{r}
re_aov <- aov(Glucose ~ Treatment*Time + Error(Animal),data = liver)
summary(re_aov)
```

### Using `lmer()` (from `lmerTest` and `lme4`) and `predictmeans()`

```{r}
library(lmerTest) ## MUST LOAD THIS
re_lmer <- lmerTest::lmer(Glucose ~ Treatment*Time + (1|Animal), data = liver) ## MUST SPECIFY WHICH PACKAGE
anova(re_lmer,type = 2)
```

```{r, eval = FALSE}
library(lme4)
library(predictmeans)
re_lmer4 <- lme4::lmer(Glucose ~ Treatment*Time + (1|Animal),data = liver) ## MUST SPECIFY WHICH PACKAGE
predictmeans::residplot(re_lmer4)
```


## Repeated measures designs as *split-plots in time*

In this set of *balanced* data we have
 + Same number of observations on each rat
 + At the same time points


We could analyse as a split-plot design, where
 + *plots* = different rats
 + *subplots* = different times within a rat

Here we would have **two** error components
 + Between rats
 + Between times within rats

There are, however, two big differences between Repeated Measures and Split-plot Designs
  1. Cannot randomise the levels of time
    + Measurement 2 hours, comes after that at 1 hour
  2. Split plot design block structure
    + Imposes the same correlation on any two subplots in the the same plot
       + Implausible for repeated measures designs as observations further apart in time likely to be less
correlated than observations close together





