## Linear mixed-effect models (LMMs)

**Recall:** Blocking helps control variability by making treatment groups more alike. Experimental units are divided into subsets (called blocks) so that units within the same block are more similar than units from different subsets or blocks. Blocking is a technique for dealing with nuisance factors. A nuisance factor is a factor that has some effect on the response, but is of no interest (e.g., age class).

**Fixed effects** are terms (parameters) in a statistical model which are fixed, or non-random, quantities (e.g., *treatment* group's mean response). For the same *treatment*, we expect this quantity to be the same from experiment to experiment.

**Random effects** are terms (parameters) in a statistical model which are considered as random quantities or variables (e.g., block id). Specifically, terms whose levels are a representative sample from a population, and where the variance of the population is of interest should be allocated as random. Setting a block as a random effect allows us to infer variation between blocks as well as the variation between experimental units within blocks.

**Key idea:** Partition known sources of variation which are unimportant to key scientific question(s) to improve precision of comparisons between treatment means.


### A Randomised Controlled Block Design (RCBD)

```{r, echo = FALSE, message = FALSE}
library(tidyverse)
rcbd <- read_csv("https://raw.githubusercontent.com/STATS-UOA/databunker/master/data/rcbd.csv")
## Note: Run should be a factor
rcbd$Run <- as.factor(rcbd$Run)
rcbd %>% dplyr::select(-logAUC4) %>%
  kableExtra::kable(.) %>%
  kableExtra::kable_classic(full_width = FALSE, html_font = "Cambria")
```


#### `Run` as a fixed effect


```{r}
lm <- lm(logAUC8 ~ Run + Surgery, data = rcbd)
summary(lm)
```


#### `Run` as a random effect


```{r}
lmer_mod <- lmerTest::lmer(logAUC8 ~ Surgery + (1|Run), data = rcbd)
summary(lmer_mod)
```


##### Inference about the *Random effects*

We have two variance components
  
  + Between Groups (Runs) $\hat{\sigma^2}_{\text{Run}}$ = 1.479
  + Within Runs (between observations) $\hat{\sigma_2}$ = 1.447
  
Note that `aov()` presents the same information, but in a different way:

```{r}
summary(aov(logAUC8 ~ Surgery + Error(Run), data = rcbd))
```

 + Within Runs (Residuals) $\hat{\sigma}_2$ = 1.447 (*same as `lmer`*)
 + Between Run variance = $\hat{\sigma}^2$ +  $3\:\hat{\sigma}^2_{\text{Run}}$ so $\hat{\sigma}^2_{\text{Run}} = \frac{5.883 - \hat{\sigma}^2 }{3} = \frac{5.883 - 1.447}{3} = 1.479$


### A Split-plot design


```{r, echo = FALSE, message = FALSE}
split_plot <-  read_csv("https://raw.githubusercontent.com/STATS-UOA/databunker/master/data/split_plot.csv")
## recall we need to set factors
split_plot$Animal <- factor(split_plot$Animal)
split_plot$Sample <- factor(split_plot$Sample)
split_plot$Disease <- factor(split_plot$Disease)
split_plot$Organ <- factor(split_plot$Organ)
split_plot %>% kableExtra::kable(.) %>%
  kableExtra::kable_classic(full_width = FALSE, html_font = "Cambria")
```

#### `Animal` as a random effect

**Using `aov()`**

```{r}
sp_aov <- aov(logAUC ~ Disease*Organ + Error(Animal), data = split_plot)
summary(sp_aov)
```

**Using `lmer()` (from `lmeTest` and `lmer4`)**

```{r}
sp_lmer <- lmerTest::lmer(logAUC ~ Disease*Organ + (1|Animal), 
                          data = split_plot) ## MUST SPECIFY WHICH PACKAGE
anova(sp_lmer,type = 2)
```

```{r}
sp_lmer4 <- lme4::lmer(logAUC ~ Disease*Organ + (1|Animal), data = split_plot) ## MUST SPECIFY WHICH PACKAGE
predmeans <- predictmeans::predictmeans(model = sp_lmer4 ,modelterm = "Disease:Organ")
predmeans$mean_table
```


### A repeated measures design (time points as factors)

```{r, message = FALSE}
liver <- read_csv("https://raw.githubusercontent.com/STATS-UOA/databunker/master/data/repeated_measures_liver.csv")
## change time to factor
liver$Time <- as.factor(liver$Time) ## this is important
liver$Treatment <- as.factor(liver$Treatment)
liver
```


```{r, echo = FALSE}
ggplot(liver, aes(x = Time, y = Glucose, color = Treatment, group = Animal)) +
  geom_line(size = 1) + 
  geom_point(shape = 1) +
  theme_linedraw() +
  ggtitle("Repeated measurments across time")
liver_means <- liver %>% group_by(Time,Treatment) %>%
  summarise(Glucose = mean(Glucose))
ggplot(liver_means, aes(x = Time, y = Glucose, color = Treatment, group = Treatment)) +
  geom_line(size = 1) + 
  geom_point(shape = 1) +
  theme_linedraw() +
  ggtitle("Repeated measurments across time, group means")
```


### `Animal` as a random effect in linear regression

```{r, echo = FALSE, message = FALSE}
ggplot(liver_means, aes(x = Time, y = Glucose, color = Treatment, group = Treatment)) +
  geom_smooth(method = "lm", se = FALSE) +
  geom_point(shape = 1) +
  theme_bw() + theme_linedraw() +
  ggtitle("Repeated measurments across time, assuming a linear model")
```

**Using `aov()`**

```{r, message = FALSE}
re_aov <- aov(Glucose ~ Treatment*Time + Error(Animal),data = liver)
summary(re_aov)
```

**Using `lmer()` (from `lmerTest` and `lme4`)**

```{r}
re_lmer <- lmerTest::lmer(Glucose ~ Treatment*Time + (1|Animal), data = liver) ## MUST SPECIFY WHICH PACKAGE
anova(re_lmer,type = 2)
```

```{r}
re_lmer4 <- lme4::lmer(Glucose ~ Treatment*Time + (1|Animal),data = liver) ## MUST SPECIFY WHICH PACKAGE
predmeans <- predictmeans::predictmeans(model = re_lmer4 ,modelterm = "Treatment:Time")
predmeans$mean_table
```







