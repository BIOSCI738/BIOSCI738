---
title: "BIOSCI738"
subtitle: "![](https://cpb-ap-se2.wpmucdn.com/blogs.auckland.ac.nz/dist/d/79/files/2015/10/uoa-v-reverse1.png){width=5%} Universty of Auckland"
author: "Charlotte M. Jones-Todd"
institute: "[bluepages](https://stats-uoa.github.io/BIOSCI738/)"
date: "Module 2: Experimental Design and Statistical Inference"
output:
  xaringan::moon_reader:
   css: xaringan-themer.css
   lib_dir: libs
   nature:
     highlightStyle: github
     highlightLines: true
     countIncrementalSlides: false
     slideNumberFormat: |
        <div class="progress-bar-container">
          <div class="progress-bar" style="width: calc(%current% / %total% * 100%);">
          </div>
        </div>
        
---
class: inverse, center, middle

```{r xaringan-themer, include=FALSE, warning=FALSE}
options(htmltools.dir.version = FALSE,cache = TRUE, warning = FALSE, message = FALSE, comment = FALSE)
options(warn=-1)
library(xaringanthemer)
xaringanExtra::use_panelset()
require(kableExtra)
style_solarized_light()
knitr::opts_chunk$set(tidy = TRUE, tidy.opts = list(comment = FALSE))
```

<style type="text/css">
.remark-slide-content {
    font-size: 20px;
    padding: 1em 4em 1em 4em;
}
</style>



# Experimental Design


---
class: inverse
## Learning Objectives


   + **Identify** the following
      + experimental unit
      + observational units
   + **List** and **describe** the three main principals of experimental design
       + Randomization
       + Replication
       + Blocking
   + **Discuss** the advantages and disadvantages of different designs
   + **Critique** experimental designs
   + **Communicate** statistical concepts and experimental outcomes clearly using language appropriate for both a **scientific** and **non-scientific** audience
   
---

# The language of design

.pull-left[![](img/cox.png)
[Gertrude Mary Cox](https://en.wikipedia.org/wiki/Gertrude_Mary_Cox)]

.pull-right[![](img/cochran.png)

[William Gemmell Cochran](https://en.wikipedia.org/wiki/William_Gemmell_Cochran)]

[Cochran, William G.; Cox, Gertrude M. (1950). Experimental Designs. New York: Wiley.](https://www.wiley.com/en-us/Experimental+Designs%2C+2nd+Edition-p-9780471545675)

---

## The language of design

#### **Scientific objective:** The biological question (**AVOID BEING VAGUE**)
  + Should include details such as what is being *compared*, what is being *measured* and *how*, and under what *experimental conditions* etc.

--
### Compare three surgical conditionings of a biofluid...

--

### **Too vague!**

--

 + Which biofluid and collected from what?
 + How will they be compared?
    + What will be measured?
    + How will it be measured?
    + Under which experimental conditions?
    + By whom?
    
???

+ Organism? Male Wistar Rat
+ Cell, tissue, biofluid? Lymph
+ What? Global proteomic profile
+ Proteins + Abundances
+ How? 2D–LC–MS/MS

---
##  Key phrases


 **Experimental unit** Smallest portion of experimental material which is *independently* perturbed
 
--

**Treatment** The experimental condition *independently* applied to an experimental unit

--

**Observational unit** The smallest unit on which a response is measured. If one measurement is made on each rat: **Observational unit** = **Experimental unit**. If Multiple measurements are made on each rat: Each experimental unit has >1 observational unit (*pseudo-* or *technical replication*).

---
class: center, middle

## Experimental or Observational unit?

`r countdown::countdown(minutes = 5, font_size = "48px", top = 0)`

### [https://b.socrative.com/login/student/](https://b.socrative.com/login/student/)
### Room Name: BIOSCIUOA


---
class: center, middle

# Three key principles:


## **Replication**
## **Randomization**
## **Blocking**


---
### Fisher... 


.pull-left[![](https://upload.wikimedia.org/wikipedia/commons/a/aa/Youngronaldfisher2.JPG)

*a genius who almost single-handedly created the foundations for modern statistical science*]

--

.pull-right[
### You should also know

[![](img/fisher.png)](https://www.newstatesman.com/international/science-tech/2020/07/ra-fisher-and-science-hatred)

[RA Fisher and the science of hatred](https://statmodeling.stat.columbia.edu/2020/08/01/ra-fisher-and-the-science-of-hatred/)

[\#Topple The Racists](https://www.bbc.com/news/uk-england-cambridgeshire-53023823)]


---

class: inverse

# 1st major principle: Replication

![](https://media.makeameme.org/created/precision-ypqmw8.jpg)

---

class: inverse

# 1st major principle: Replication

+ **Biological replication:** each treatment is *independently* applied to each of several humans, animals or plants
  + To generalize results to population

--

+ **Technical replication:** two or more samples from the same biological source which are *independently* processed
  + Advantageous if processing steps introduce a lot of variation
  + Increases the precision with which comparisons of relative abundances between treatments are made
  
--

+ **Pseudo-replication:** one sample from the same biological source, divided into two or more aliquots which are **independently** measured
  + Advantageous for noisy measuring instruments
  + Increases the **precision** with which comparisons of relative abundances between treatments are made
  
---

class: inverse

# 2nd major principle: Randomisation

![](https://media.makeameme.org/created/your-bias-is.jpg)

---

class: inverse

# 2nd major principle: Randomisation

+ **Protects against bias**


+ Plan the experiment in such a way that the variations caused by extraneous factors can all be combined under the general heading of "chance".

+ Ensures that each treatment has the same probability of getting good (or bad) units and thus
avoids systematic bias
+ random allocation can cancel out population bias; it ensures that any other possible causes for the experimental results are split equally between groups
+ typically statistical analysis assumes that observations are **independent**. This is almost never strictly true in practice but randomisation means that our estimates will behave as if they were based on independent observations

---

class: inverse

# 3rd major principle: Blocking

![](https://www.memecreator.org/static/images/memes/4524459.jpg)
---

class: inverse

# 3rd major principle: Blocking


Blocking helps **control variability** by making treatment groups more alike. Experimental units are divided into subsets (called blocks) so that units within the same block are more similar than units from different subsets or blocks. 

Blocking is a technique for dealing with *nuisance factors*.

A *nuisance factor* is a factor that has some effect on the response, but is of no interest (e.g., age class).



---

# Other resources


[Glass, David J. Experimental Design for Biologists. Second ed. 2014. Print.](https://catalogue.library.auckland.ac.nz/primo-explore/fulldisplay?docid=uoa_alma21237737730002091&search_scope=Combined_Local&tab=books&vid=NEWUI&context=L)

[Welham, S. J. Statistical Methods in Biology : Design and Analysis of Experiments and Regression. 2015. Print.](https://catalogue.library.auckland.ac.nz/primo-explore/fulldisplay?docid=uoa_alma21237737830002091&search_scope=Combined_Local&tab=books&vid=NEWUI&context=L)

[Fisher, Ronald Aylmer. The Design of Experiments. 8th ed. Edinburgh: Oliver & Boyd, 1966. Print. O & B Paperbacks.](https://catalogue.library.auckland.ac.nz/primo-explore/fulldisplay?docid=uoa_alma21198532990002091&context=L&vid=NEWUI&lang=en_US&search_scope=Combined_Local&adaptor=Local%20Search%20Engine&isFrbr=true&tab=books&query=any,contains,The_Design_of_Experiments&sortby=date&facet=frbrgroupid,include,627497507&offset=0)


---
class: inverse, center, middle

# One-Way **An**alysis **o**f **Va**riance (ANOVA)
## Sums of Squares (SS)
## Mean Sums of suares (MSS)
## Degrees of freedom

---
class: inverse
## Learning Objectives

+ **Calculate** Sums of Squares (between and within groups) given the observations 
+ **Define** and **state** the appropriate degrees of freedom in a one-way ANOVA scenario
+ **Calculate** the F-statistics given the appropriate Sums of Squares and degrees of freedom
+ **Interpret** and **discuss** a given *p-value* in the context of a stated hypothesis test

---

## The data

```{r data-quiet, message = FALSE, echo = FALSE}
library(tidyverse)
rats <- read_csv("../data/crd_rats_data.csv")
rats$Surgery <- as_factor(rats$Surgery)
```

```{r, echo = FALSE, results = "asis"}
knitr::kable(rats)
```

---

**The idea**: Assess **distances** between treatment (*surgical condition*) means relative to our uncertainty about the actual (*true*) treatment means.

```{r, echo = FALSE}
means <- rats %>% group_by(Surgery) %>% summarise(avg = mean(logAUC))
mean <- mean(rats$logAUC)
ggplot(rats, aes(x = Surgery, y = logAUC)) + 
    geom_violin()  + 
  ylab("logAUC") +
  xlab("Treatment") +
  geom_point(data = means, aes(x = Surgery, y = avg, color = Surgery), size = 2) +
  geom_text(data = means, aes(x = Surgery, y = avg + 0.25, color = Surgery, label = paste0("Treatment mean = ",round(avg,3)))) +
  geom_hline(data = means, aes(yintercept = avg, color = Surgery), alpha = 0.3, lty = 2) +
  geom_hline(yintercept = mean, color = "red") +
  annotate(geom = 'text', label = paste0("Overall average = ",round(mean,3)) , 
           x = -Inf, y = Inf, hjust = 0, vjust = 1.5, color = "red")
  
  
```

---
 **The idea**: Assess **distances** between treatment (*surgical condition*) means relative to our uncertainty about the actual (*true*) treatment means.

```{r, echo = FALSE}
means <- rats %>% group_by(Surgery) %>% summarise(avg = mean(logAUC))
mean <- mean(rats$logAUC)
means$ends <- mean
ggplot(rats, aes(x = Surgery, y = logAUC)) + 
    geom_violin()  + 
  ylab("logAUC") +
  xlab("Treatment") +
  geom_point(data = means, aes(x = Surgery, y = avg, color = Surgery), size = 2) +
  geom_text(data = means, aes(x = Surgery, y = avg + 0.25, color = Surgery, label = paste0("Treatment mean = ",round(avg,3)))) +
  geom_hline(data = means, aes(yintercept = avg, color = Surgery), alpha = 0.3, lty = 2) +
  geom_hline(yintercept = mean, color = "red", alpha = 0.3) +
  annotate(geom = 'text', label = paste0("Overall average = ",round(mean,3)) , 
           x = -Inf, y = Inf, hjust = 0, vjust = 1.5, color = "red") +
  geom_segment(data = means, aes(x = Surgery, y = avg, xend = Surgery, yend = ends,color = Surgery), size = 1) +
  geom_text(data = means, aes(x = Surgery, y = ends + 0.25, color = Surgery, label = paste0("diff to overall = ",round(avg - ends,3))))
  
  
```

--

**add up the differences:** `r round(means$avg[1] - mean,3)` + `r round(means$avg[2] - mean,3)` + `r round(means$avg[3] - mean,3)` = `r round(sum(means$avg - mean),3)`. **This is always the case!**

---
**So adding up the differences:** `r round(means$avg[1] - mean,3)` + `r round(means$avg[2] - mean,3)` + `r round(means$avg[3] - mean,3)` = `r round(sum(means$avg - mean),3)`. **Not a great way to measure distances!**

--

**Sums of Squares?** 

--

$`r round(means$avg[1] - mean,3)`^2 + `r round(means$avg[2] - mean,3)`^2 + `r round(means$avg[3] - mean,3)`^2$

**add up the squared differences?** but... there are 4 observations in each group (treatment)

--

$4\times(`r round(means$avg[1] - mean,3)`)^2 + 4\times(`r round(means$avg[2] - mean,3)`)^2 + 4\times(`r round(means$avg[3] - mean,3)`)^2$

This is the **Between Groups Sums of Squares** or the **Between group SS (SSB)** 

--

So the Between group SS (SSB) = `r sum(4*((means$avg - mean)^2))`

---

**Adding up the differences:** `r round(means$avg[1] - mean,3)` + `r round(means$avg[2] - mean,3)` + `r round(means$avg[3] - mean,3)` = `r round(sum(means$avg - mean),3)`. **This is always the case** and that itself gives us information...

--

**We only need to know two of the values to work out the third!**

So we have only 2 bits of **unique** information; **SSB degrees of freedom** = 2



---
Now:  Each observation (*logAUC*) can be *decomposed* in the same way

```{r, echo = FALSE, results = "asis"}
rats_df <- rats %>% mutate(ov_avg = mean(logAUC)) %>% 
  group_by(Surgery) %>% mutate(tr_avg = mean(logAUC), tr_avg_minus_ov_avg = mean(logAUC) - ov_avg,
                               obvs_minus_tr_avg = logAUC - mean(logAUC))
knitr::kable(rats_df, format = 'html')
```


---

`logAUC` = `ov_avg` + `tr_avg_minus_ov_avg` + `obvs_minus_tr_avg` $\rightarrow$ **observation** = **overall average** + **treatment average minus overall average** + **observation minus treatment average**

```{r, echo = FALSE, results = "asis"}
rats_illus <- select(ungroup(rats_df), -c(Surgery,Rat, tr_avg))
rats_illus <- add_column(rats_illus, "equals" = "=", .after = "logAUC")
rats_illus <- add_column(rats_illus, "add" = "+", .after = "ov_avg")
rats_illus <- add_column(rats_illus, "plus" = "+", .after = "tr_avg_minus_ov_avg")
knitr::kable(rats_illus, format = 'html')
```

---
Remember the **Between group SS (SSB)** *variation due to treatments*

--

The **Within group SS (SSW)** arises from the same idea:

To assess distances between treatment (surgical condition) means **relative** to our uncertainty about the actual (true) treatment means.

--

Procedure:

 + Observation - Treatment mean
 + Square the difference
 + Add them up!
 
---
**Within group SS (SSW)** *unexplained variance*

```{r,echo = FALSE}
jit <- ggplot() + 
  geom_jitter(data = rats, aes(x = Surgery, y = logAUC))

rats_df$x_points <- layer_data(jit)$x
rats_df$y_points <- layer_data(jit)$y

ggplot() + 
  ylab("logAUC") +
  xlab("Treatment") +
  geom_point(data = means, aes(x = Surgery, y = avg, color = Surgery), size = 2) +
  geom_text(data = means, aes(x = Surgery, y = avg + 0.25, color = Surgery, 
                              label = paste0("Treatment mean = ",round(avg,3)))) +
  geom_hline(data = means, aes(yintercept = avg, color = Surgery), alpha = 0.3, lty = 2) +
  geom_point(data = rats_df, aes(x = x_points, y = y_points, color = Surgery), alpha = 0.3) +
  geom_segment(data = rats_df, aes(x = x_points, y = y_points, 
                                   xend = x_points, yend = tr_avg,color = Surgery), 
               size = 1, alpha = 0.5) +
    theme(legend.position = "none")
```

---

Recall the Between group SS (**SSB**) = `r sum(4*((means$avg - mean)^2))`

So mean **SSB** =  `r sum(4*((means$avg - mean)^2))` / 2

--

The within group SS (**SSW**) = `r sum(rats_df$obvs_minus_tr_avg^2)`

Here we have $2\times 3$ bits of *unique* information: within groups **degrees of freedom** is 9.

So mean **SSW** = `r round(sum(rats_df$obvs_minus_tr_avg^2),3)`/9

--

Consider the ratio ${\frac  {{\text{variation due to treatments}}}{{\text{unexplained variance}}}} = {\frac  {{\text{ mean between-group variability}}}{{\text{mean within-group variability}}}}$  $=\frac{\text{mean SSB}}{\text{mean SSW}}$ $=\frac{\text{MSB}}{\text{MSW}}$  = $=\frac{\text{experimental variance}}{\text{error variance}}$ `r (sum(4*((means$avg - mean)^2))/2)/(sum(rats_df$obvs_minus_tr_avg^2)/9)`

--

This is the **F-statistic**... more to come!


---
class: inverse, center, middle

# Analysis of a Completely Randomised Design in `R`
## `aov()` and `lm()`

---
class: inverse
## Learning Objectives

+ **Explain** between group and within group variation
+ **Describe** a Completely Randomised (experimental) Design 
+ **Carry** out linear regression in `R` with one categorical explanatory variable (one-way ANOVA) and **draw** the appropriate inference
+ **Communicate** statistical concepts and experimental outcomes clearly using language appropriate for both a **scientific** and **non-scientific** audience


---

## One-way ANOVA


```{r data, message = FALSE, eval = FALSE}
library(tidyverse)
rats <- read_csv("crd_rats_data.csv")
```

```{r means}
rats %>%
  group_by(Surgery) %>%
  summarise(avg = mean(logAUC))
```



---

## One-way ANOVA `aov()`


```{r aov}
rats_aov <- aov(logAUC ~ Surgery, data = rats)
rats_aov
```

.footnote[recognize the **Sums of Squares** values?]

---

```{r lm-quiet, echo = FALSE}
rats_lm <- lm(logAUC ~ Surgery, data = rats)
```

## Inference

Hypothesis: We test the Null hypothesis, $H_0$, population (`Surgery`) means are the same on average verses the alternative hypothesis, $H_1$, that **at least one** differs from the others!

Probability of getting an **F-statistic** at least as extreme as the one we observe (think of the area under the tails of the curve below) **p-value** Pr(>F)= `r round(anova(rats_lm)$"Pr(>F)"[1],4)` tells us we have sufficient evidence to reject $H_0$ at the 1% level of significance


---

## Inference


```{r f, echo = FALSE}
stats_df <- data.frame(Fs = summary(rats_aov)[[1]][[4]][[1]])
crit_df <- as.data.frame(apply(stats_df,2,rep,each = 100))
crit_df$Fs <- c(sapply(stats_df$Fs, function(x) seq(x,20, length.out = 100)))
crit_df$y <- df(crit_df$Fs,df1 = 2,df2 = 9) ## corresponding F val
ggplot(stats_df,aes(x = Fs)) +
  geom_vline(aes(xintercept = Fs)) +
    geom_line(data = data.frame(x = seq(0,20,.1),
                              y  = df(seq(0,20,.1),df1 = 2,df2 = 9)),
              aes(x = x,y = y), alpha = 0.7) +
    theme(legend.position = "none") +
    ylab("density") +
    xlab("F-value") +
    geom_area(data = crit_df,mapping = aes(x = Fs,y = y),fill = "blue") +
  geom_line(data = crit_df,mapping = aes(x = Fs,y = y),color = "blue") +
  geom_text(aes(4, 1,label = paste("F-statistic:", format(round(Fs, 2), nsmall = 2))),
              size = 4, hjust = 0, color = "black")  +
  geom_text(aes(4, 0.95,label = paste("p-value:", format(round(pf(Fs,2,9,lower.tail = FALSE),4), 
                                                         nsmall = 2))),
              size = 4, hjust = 0, color = "blue") 

```
---

# `r emo::ji('scream')` p-values `r emo::ji('scream')`

### [The ASA Statement on p-Values: Context, Process, and Purpose](https://www.tandfonline.com/doi/full/10.1080/00031305.2016.1154108)

**Q:** Why do so many colleges and grad schools teach *p-val*=0.05?


**A:** Because that's still what the scientific community and journal editors use.


**Q:** Why do so many people still use *p-val*=0.05?


**A:** Because that's what they were taught in college or grad school. 

---

# `r emo::ji('scream')` p-values `r emo::ji('scream')`

**What is a p-Value?**

Informally, a p-value is the probability under a specified statistical model that a statistical summary of the data (e.g., the sample mean difference between two compared groups) would be equal to or more extreme than its observed value


---
# `r emo::ji('scream')` p-values `r emo::ji('scream')`

**p-values** can indicate how incompatible the data are with a specified statistical model

--

p-values **do not** measure the probability that the studied hypothesis is true, or the probability that the data were produced by random chance alone

--

Scientific conclusions and business or policy decisions **should not** be based only on whether a p-value passes a specific threshold

--

Proper inference requires **full** reporting and transparency

--

A p-value, or statistical significance, does **not** measure the size of an effect or the importance of a result

--

By itself, a p-value does **not** provide a good measure of evidence regarding a model or hypothesis

---
# `r emo::ji('scream')` p-values `r emo::ji('scream')`

> "Good statistical practice, as an essential component of good scientific practice, 
> emphasizes principles of good study design and conduct, a variety of numerical 
> and graphical summaries of data, understanding of the phenomenon under study, 
> interpretation of results in context, complete reporting and proper
> logical and quantitative understanding of what data summaries mean. 
> No single index should substitute for scientific reasoning." `r tufte::quote_footer('--- ASA Statement on p-Values')`


---
class: inverse

The **ANOVA** enables us to:

 + Test only  the global null hypothesis of *no difference between any of the treatment groups' means*
	
 + Estimate the population variance. (We'll come back to why this is important)

--

But...


A primary goal of our experiment

  + *Biologically speaking:* To identify which pairs  of treatments are biologically different from one another
  
  + *Statistically speaking:* To identify which pairs of treatment means  are statistically  different from one another 


---

## Everything is a regression...

![](https://pbs.twimg.com/media/EeMWb7QWsAIGftR?format=jpg&name=small)

---

## Looking forward

| Traditional name    | Model formula  | R code  |
| ------------------- |:--------------:| -------:|
| Simple regression   | $Y \sim X_{continuous}$ | `lm(Y ~ X)` |
| One-way ANOVA       | $Y \sim X_{categorical}$      |   `lm(Y ~ X)` |
| Two-way ANOVA       | $Y \sim X1_{categorical} + X2_{categorical}$| `lm(Y ~ X1 + X2)` |
| ANCOVA              | $Y \sim X1_{continuous} + X2_{categorical}$ |`lm(Y ~ X1 + X2)` |
| Multiple regression | $Y \sim X1_{continuous} + X2_{continuous}$ | `lm(Y ~ X1 + X2)` |
| Factorial ANOVA     | $Y \sim X1_{categorical} * X2_{categorical}$|   `lm(Y ~ X1 * X2)` or `lm(Y ~ X1 + X2 + X1:X2)` |


---

## One-way ANOVA `lm()`

```{r lm}
rats_lm <- lm(logAUC ~ Surgery, data = rats)
anova(rats_lm)
```

.footnote[recognize the **Sums of Squares** values?]

---


## Inference `lm()`

```{r lmsum}
summary(rats_lm)$coef
```

.footnote[Taking **treatment** `SurgeryC` as the **baseline**...]
---
class: center, middle


```{r, echo = FALSE}
means$base <- summary(rats_lm)$coef[1,1]
ggplot(rats, aes(x = Surgery, y = logAUC)) + 
    geom_violin()  + 
  ylab("logAUC") +
  xlab("Treatment") +
  geom_point(data = means, aes(x = Surgery, y = avg, color = Surgery), size = 2) +
  geom_text(data = means, aes(x = Surgery, y = avg + 0.25, color = Surgery, label = paste0("Treatment mean = ",round(avg,3)))) +
  geom_hline(data = means, aes(yintercept = avg, color = Surgery), alpha = 0.3, lty = 2) +
  geom_segment(data = means[2:3,], aes(x = Surgery, y = avg, xend = Surgery, yend = base,color = Surgery), size = 1) +
  geom_text(data = means[2:3,], aes(x = Surgery, y = base - 0.25, color = Surgery, label = paste0("diff to baseline = ",round(avg - base,3)))) +
  geom_hline(data = means[1,], aes(yintercept = avg, color = Surgery)) +
  geom_text(data = means[1,],aes(x = Surgery, y = base - 0.25, color = Surgery, label = paste0("Baseline = ",round(avg,3))))
  
```
---
## Inference `lm()`

Which pairs of means are different?
 + Pair-wise comparisons of means
  	+ Use two-sample t-tests
 	+ We need to calculate our **observed**  t-value where
$\text{t-value} = \frac{\text{Sample Difference}_{ij} - \text{Difference assuming } H_0 \text{ is true}_{ij}}{\text{SE of } \text{Sample Difference}_{ij}}$
 where
   $\text{Sample Difference}_{ij}$ = Difference between pair of sample means
 + Compute the p-value for observed t-value


---

## Inference `lm()`

```{r lmsum2}
summary(rats_lm)$coef
```


(Intercept) = $\text{mean}_C$ = `r summary(rats_lm)$coef[1,1]`

SE of (Intercept) = SE of $\text{mean}_C$ = SEM = `r summary(rats_lm)$coef[1,1]`

$\text{Surgery}_P$ = $\text{mean}_P$ – $\text{mean}_C$ = `r summary(rats_lm)$coef[2,1]`

SE of $\text{Surgery}_P$ = SE of ($\text{mean}_P$ - $\text{mean}_C$ ) = SED = `r summary(rats_lm)$coef[2,2]`

---

## Hypotheses being tested

+ The t value and Pr (>|t|) are the t - and p-value for testing the null hypotheses:
	+ Mean abundance is zero for C population
	+ No difference between the population means of P and C
	+ No difference between the population means of S and C

We’re interested in 2 and 3, but not necessarily 1!

 Two-sample t -tests for pairwise comparisons of means
 
+ SurgeryP : t value = Estimate ÷ Std.Error =  0.8446; Pr (>|t|) =  0.4202
	
.footnote[Cannot get t - or p -value of mean P – mean S directly from table]

---
### Estimation of $\sigma^2$
```{r, echo = FALSE}
anova(rats_lm)
```
Some notation:

+ $\sigma^2$ denotes the **population** variance
+ $s^2$ denotes the **sample** variance, i.e. is estimated from dataset
+ A hat (^) above a maths symbol means an *estimated value*
+ So, what is the value of $\sigma^2$?

`r countdown::countdown(minutes = 0.5, font_size = "48px", top = 0)`
	
--
0.6732
 
---
#### Standard Error of the Mean, SEM, 
#### Error of the Difference between two means, SED

What is the difference?

+ From Analysis of Variance Table:
	+ **SEM** = $\sqrt{\frac{\hat{\sigma^2}}{n}} = \sqrt{\frac{0.673}{4}} = 0.4103$ ($n$ is the group replication)
	+ **SED** = $\sqrt{\frac{2\times\hat{\sigma^2}}{n}} = \sqrt{\frac{2 \times0.673}{4}} = 0.5801$ (only true for equi-replicated groups)

```{r tbl12, echo = FALSE}
tbl12 <- tibble::tribble(
~`Group`, ~`Mean`, ~`Standard Errors`, ~` `,
" "," ","SEM","SED",
"C","8.460","0.4103","0.5801",
"P","8.950","0.4103","0.5801",
"S","11.547","0.4103","0.5801"
)

kableExtra::kable_styling(knitr::kable(tbl12), font_size = 18)
```

---
class: inverse, middle

## There’s an easier way!!

### Use package `predictmeans`
		

---
###  Analysis of a CRD Using the `predictmeans` package

```{r,echo = FALSE}
options(warn=-1)
```

```{r predmeans, message=FALSE, warnings = FALSE}
# Load predictmeans (assumes already installed)
library(predictmeans)
pred_means <- predictmeans(rats_lm , modelterm = "Surgery",pairwise = TRUE, adj = "none", plot = FALSE)
pred_means$`Predicted Means`
```

---
###  Analysis of a CRD Using the `predictmeans` package

**compare** 

```{r}
rats_lm
```


$\text{Surgery_P}$ = P mean – C mean 		0.490 = 8.9500 – 8.4600
$\text{Surgery_S}$ = S mean – C mean 		3.087 = 11.5475 – 8.4600

What about the difference between $\text{Surgery_S}$ and $\text{Surgery_P}$?

S mean – P mean       = 11.5475 – 8.9500  =   2.5975
$\text{Surgery_S}$ – $\text{Surgery_P}$ =   3.087 – 0.490    =   2.597


---
###  Analysis of a CRD Using the `predictmeans` package

```{r}
pred_means$`Standard Error of Means`
pred_means$LSD
```

.footnote[All **SED**s the same, - each level of Treatment factor, Surgery,  has the same replication]

---
###  Analysis of a CRD Using the `predictmeans` package

```{r}
pred_means$`Pairwise LSDs`
```

.footnote[LSDs matrix has **mean** differences (row-col) **above** the diagonal, LSDs below the diagonal]

---
###  Analysis of a CRD Using the `predictmeans` package

```{r}
pred_means$`Pairwise p-value`
```

.footnote[The matrix has t-value above the diagonal, p-value (adjusted by ‘none’ method) below the diagonal]


---

### How would you summarise this info?


`r countdown::countdown(minutes = 1, font_size = "48px", top = 0)`

--

.panelset[.panel[.panel-name[Table?]
```{r tbl19, echo = FALSE}
tbl19 <- tibble::tribble(
~`Group`, ~`Mean`, ~`SE`, ~`t`, ~`p`,
"C","8.460","0.225","-0.845","0.4202",
"P","8.950","0.542","-5.322","0.0005",
"S","11.547","0.400","-4.477","0.0015"
)
kableExtra::kable_styling(knitr::kable(tbl19), font_size = 18)
```
]
.panel[.panel-name[Please no...]
```{r dynamite, echo = FALSE}
ggplot(rats) +
  aes(x = Surgery, y = logAUC,) +
  stat_summary(aes(width = .8), geom = "bar", fun.y = "mean") +
  stat_summary(geom = "errorbar", fun.data = "mean_se", width = .2)
```

]
.panel[.panel-name[Mean +/- 2SEs]
```{r d2 SEs, echo = FALSE}
cdata <- plyr::ddply(rats, "Surgery", summarise,
               N    = length(logAUC),
               mean = mean(logAUC),
               sd   = sd(logAUC),
               se   = sd / sqrt(N))
pd <- position_dodge(0.78)

ggplot(cdata, aes(x = Surgery, y = mean, group = Surgery)) +
      geom_point(position=pd) +
      geom_errorbar(data=cdata, aes(ymin=mean-2*se, ymax=mean+2*se), 
                    width=.1, position=pd)

```
]
.panel[.panel-name[Mean $\pm$ 2SEs]

```{r, echo = FALSE}
ggplot(data = rats, aes(x = Surgery, y = logAUC)) +
    geom_point(size = 4, alpha = .5) + 
    stat_summary(fun.data = "mean_cl_normal", geom = "crossbar") +
    labs(title = "95% Mean Confidence Intervals")
```
]
]
---

## Why error bars that are $\pm$ twice the SE?

This is approx. the 95% confidence interval for the population mean

The exact 95% CI is given by
  + Mean $\pm$ $t_{df,1 - \alpha/2}$ $\times$ SEM
 ( df = degrees of freedom; $\alpha$ = level of significance)

Each mean has its own confidence interval whose width depends on the SEM for that mean

When the df are large (e.g. 30 or greater) and $\alpha$ = 0.05 $t_{df,1 - \alpha/2}$ = $t_{large,0.975}$ $\approx$ 2

Hence, the 95% confidence interval for the population mean is approximately Mean ± 2 $\pm$ SEM
	
---

## 95% CI for the Control group mean

$t_{df,1 - \alpha/2}$ = $t_{9,1 - 0.05/2}$ = 2.262

(In `R` $t_{9,1 - 0.05/2}$ = `qt (0.975, 9)` )
LSD = $t_{9,1 - 0.05/2} \times$ SED = 2.262  $\times$  0.41025

95% CI: 8.460 $\pm$ 0.928 = ( 7.532, 9.388)


```{r tbl22, echo = FALSE}
tbl22 <- tibble::tribble(
~`Group`, ~`Mean`, ~`SE`, ~`t`, ~`p`,
"C","8.460","0.225","-0.845","0.4202",
"P","8.950","0.542","-5.322","0.0005",
"S","11.547","0.400","-4.477","0.0015"
)

kableExtra::kable_styling(knitr::kable(tbl22), font_size = 18)
```

---

### The Least significant difference, LSD


+ The LSD = $t_{df,1 - \alpha/2}$ $\times$  SED
	
+ The SED is the **S**tandard **E**rror of the **D**ifference (of a pair of means)

+ SED = $\sqrt{SEM_1^2 + SEM_2^2}$
		
+ When the two means have the same replication SED = $\sqrt{2} \times$  SEM

+  When a pair of means differ by **more** than  the LSD, we say:

*Their difference is statistically significant at the 100 $\alpha$ % level*

---

### Which means are significantly different?

```{r,echo = TRUE}
predictmeans(rats_lm , modelterm = "Surgery",pairwise = TRUE, adj = "none", plot = TRUE)
```
---
class: inverse, middle, center

## Model diagnostics and data transformations

---
#  Key assumptions of Analysis of Variance 

Observations are **independent**
 
+ Check experiment description
+ How were data collected?
	
All observations have the **same variance**

+ Spread of the observations does not depend on the Treatment Mean
	
All observations are (approximately) normally distributed.

---

#### Raw AUC data


```{r raw, echo = FALSE}
rats$AUC <-  exp(rats$logAUC) 
ggplot(rats, aes(x = Surgery, y = AUC)) +
         geom_boxplot() +
         geom_dotplot(binaxis = "y", stackdir = "center", dotsize = 0.75) +
         theme_bw() + xlab("Raw AUC")
```

--

.footnote[<span style="color:red">Shows variability in AUC increases with mean AUC</span>]
---

#### Log AUC data


```{r raw2, echo = FALSE}
ggplot(rats, aes(x = Surgery, y = logAUC)) +
         geom_boxplot() +
         geom_dotplot(binaxis = "y", stackdir = "center", dotsize = 0.75) +
         theme_bw() + xlab("log AUC")
```

--

.footnote[<span style="color:red">Shows variability in AUC not related with mean `logAUC`</span>]

---

## Residual plot to evaluate homogeneity of variances assumption

Plot residuals against the estimated values
of the treatment means (Predicted Values)

--

If the variability of the observations around
the treatment means differs between
groups, this will be reflected in the residual
plot

---

## Residual plot to evaluate homogeneity of variances assumption

```{r}
crd.lm <- lm(AUC ~ Surgery, data = rats)
anova(crd.lm)
```



---

## Residual plot to evaluate homogeneity of variances assumption


```{r resids}
rats$Residuals <- residuals(crd.lm)
# Extract predicted (fitted) values and add to the data frame
rats$Fitted.Values <- fitted.values(crd.lm)
rats
```

---

### Is the homogeneity of variance assumption satisfied?

`r countdown::countdown(minutes = 2, font_size = "48px", bottom = 0)`

.panelset[
 .panel[.panel-name[Plot]
 
```{r, echo = FALSE, fig.height = 5}
fan <- ggplot(rats, aes(x = Fitted.Values, y = Residuals)) +
  theme_bw() + 
  geom_point(size = 4, shape = 18) +
  geom_hline( yintercept = 0, col = 2, size = 2) +
  geom_abline( intercept = 0, slope = +1.5, col = 4, linetype = 2 ,size = 2) +
  geom_abline( intercept = 0, slope = -1.5, col = 4, linetype = 2 ,size = 2)
fan
```
]
.panel[.panel-name[Code]
```{r plot residscc, eval = FALSE}
ggplot(rats, aes(x = Fitted.Values, y = Residuals)) +
  theme_bw() + 
  geom_point(size = 4, shape = 18) +
  geom_hline( yintercept = 0, col = 2, size = 2) +
  geom_abline( intercept = 0, slope = +1.5, col = 4, linetype = 2 ,size = 2) +
 geom_abline( intercept = 0, slope = -1.5, col = 4, linetype = 2 ,size = 2)

```
]
]

--

Residuals increase in variability with predicted mean values so our equal variance assumption is **violated**

---

#### Other diagnostic plots

```{r qqnorm}
gglm::gglm(crd.lm) # Plot the four main diagnostic plots
```

---

## QQplot

+ Normal quantile-quantile (QQ) plot

  • Plot sorted residuals versus expected order statistics from a standard normal distribution

+ Samples should be close to a line

+ Points moving away from 45 degree line at the tails suggest the data are from a skewed distribution, but it is difficult to be confident with so few data points


---
##  Outliers 
### Causes

+ Errors in collecting and/or recording of data
+ Mistakes in technique
+ Treatment and/or environment
+ Affect statistical inference
+ Inflation of estimated experimental error variance
+ Influence estimate of treatment mean
+ Investigate cause before discarding data
+ Discarded data results in loss of information

---
###  Looking for outliers with residuals 

+ Large positive or negative values far removed from the 1-to-1 line in the normal QQ plot
	+ Points far removed from upper and lower boundaries of the Residuals versus Predicted values plot

---
###  Variance stabilizing transformations 

+ Used to change the scale of the observations
	+ To conform more closely with the ANOVA assumptions
	+ To provide more valid inferences from ANOVA
	+ Significance levels ($\alpha$) don't apply to original data
	+ Conduct analysis and make all inferences on transformed
	+ Present summary tables on the original measurement scale

---

### logAUC

```{r}
rats_lm <- lm(logAUC ~ Surgery, data = rats)
anova(rats_lm)
```

---


.panelset[.panel[.panel-name[Before transform]
```{r}
gglm::gglm(crd.lm)
```
]
.panel[.panel-name[After transform]
```{r}
gglm::gglm(rats_lm)
```
]
]

---

.panelset[.panel[.panel-name[Before differences]
```{r}
pm.lm <- predictmeans(crd.lm, modelterm="Surgery", pairwise = TRUE, plot = FALSE)
pwLSDs.pmlm <- pm.lm$"Pairwise LSDs"
diffs <- pwLSDs.pmlm[upper.tri(pwLSDs.pmlm)]
LSDs <- pwLSDs.pmlm[lower.tri(pwLSDs.pmlm)]
diffNames <- c("C-P", "C-S", "P-S")
pValues.pmlm <- pm.lm$`Pairwise p-value`
before <- data.frame(diff = diffNames, Difference = diffs,
           SED = pm.lm$"Standard Error of Differences",
           LSD = LSDs, lowerLimit = diffs-LSDs, upperLimit=diffs+LSDs,
           "p-value" = pValues.pmlm[lower.tri(pValues.pmlm)])
knitr::kable(before)
```

]
.panel[.panel-name[After differences]
```{r}
pm.lm <- predictmeans(rats_lm, modelterm="Surgery", pairwise = TRUE, plot = FALSE)
pwLSDs.pmlm <- pm.lm$"Pairwise LSDs"
diffs <- pwLSDs.pmlm[upper.tri(pwLSDs.pmlm)]
LSDs <- pwLSDs.pmlm[lower.tri(pwLSDs.pmlm)]
diffNames <- c("C-P", "C-S", "P-S")
pValues.pmlm <- pm.lm$`Pairwise p-value`
after <- data.frame(diff = diffNames, Difference = diffs,
           SED = pm.lm$"Standard Error of Differences",
           LSD = LSDs, lowerLimit = diffs-LSDs, upperLimit=diffs+LSDs,
           "p-value" = pValues.pmlm[lower.tri(pValues.pmlm)])
knitr::kable(after)
```
]]

---

## Interpreting results

+ Data on the original scale
  $y_{c1}, y_{c2}, y_{c3}, y_{c4},...,y_{s4}$
  
+ On the log-scale
  $\text{log}(y_{c1}), \text{log}(y_{c2}), \text{log}(y_{c3}), \text{log}(y_{c4}),...,\text{log}(y_{s4})$
  
+ Mean of C group
  $\frac{\text{log}(y_{c1}) + \text{log}(y_{c2}) + \text{log}(y_{c3}) + \text{log}(y_{c4})}{4}$ = $\frac{1}{4}(\text{log}(y_{c1}) + \text{log}(y_{c2}) + \text{log}(y_{c3}) + \text{log}(y_{c4}))$
  

---

## Interpreting results
### Useful log rules

+ $\text{log}(A) + \text{log}(B) = \text{log}(AB)$
+ $\text{log}(A) - \text{log}(B) = \text{log}(\frac{A}{B})$
+ $n\text{log}(A) = \text{log}(A^n)$

---

## Interpreting results

Mean of C group $\bar{x_c}$

$\bar{x_c} = \frac{1}{4}(\text{log}(y_{c1}) + \text{log}(y_{c2}) + \text{log}(y_{c3}) + \text{log}(y_{c4})) = \text{log}(y_{c1} \times y_{c2} \times y_{c3} \times y_{c4})^\frac{1}{4}$

Back-transform to original scale (*geometric mean*)

$e^\bar{x_c}$ = $(y_{c1} \times y_{c2} \times y_{c3} \times y_{c4})^\frac{1}{4}$

---

## Interpreting results

Difference between two group means (C and P) $\bar{x_p} - \bar{x_c}$
  
Back-transform to original scale $e^{\bar{x_p} - \bar{x_c}} = \frac{e^{\bar{x_p}}}{e^\bar{x_c}}$ (*ratio of two geometric means*)

 + Ratio of 1 implies that the average abundance of protein X in P group, relative to C group, is the same
 
 + If however, the ratio were 1.5 then the average abundance of protein X in P group is 50% higher than in the C group
 

---
 
 ## Interpreting results
 
```{r}
knitr::kable(after)
```

```{r tbl50, echo = FALSE}
tbl50 <- tibble::tribble(
~` `, ~`Log-scale`, ~` `, ~`Original scale`, ~` `,
"Comparison","Estimated Difference","Standard Error","Ratio","95% CI",
"C – P","-0.4900","0.5802","0.61","(0.16, 2.27)",
"C – S","-3.0875","0.5802","0.05","(0.01 0.17)",
"P – S","-2.5975","0.5802","0.07","(0.02, 0.28)"
)

kableExtra::kable_styling(knitr::kable(tbl50), font_size = 18)
```

---
class: inverse, middle, center

## Errors in hypothesis testing and the multiple testing problem


---
##  Example: Proteome of lymph 

### There are 3 group means

+ Which pairs, if any, are different from one another?
+ Carry out multiple comparisons/hypothesis tests
	
	
     + $H_{01}$: $\mu_C$ = $\mu_P$
	   + $H_{02}$:  $\mu_C$ = $\mu_S$
	   + $H_{03}$:  $\mu_P$ = $\mu_S$

---
##  Statistical hypothesis testing 

Two competing claims, or hypotheses
+ Assertions about the true value of some population characteristic.
	+ e.g., population mean, $\mu$

+ Claim 1: **Null**  hypothesis, $H_0$  (no difference)
versus
+ Claim 2: **Alternative**  hypothesis, $H_A$  (there is a difference)
	+ Usually the claim the researcher wants to validate

---

## For any single hypothesis: Type I error
+ Declare a difference (i.e. reject $H_0$ ) when there is no difference (i.e. $H_0$ is true)
	+ Also known as a false positive or false discovery
	+ Risk of the Type I error is determined by the “level of significance”, i.e.
	+ $\alpha$ = Pr (Type I error) = Pr (false discovery)
	+ We choose this!
		+ $\alpha$ = 0.05 is a popular choice by biologists `r emo::ji("scream")` `r emo::ji("warning")` `r emo::ji("scream")`
---
class: inverse

![](https://raw.githubusercontent.com/allisonhorst/stats-illustrations/master/other-stats-artwork/type_1_errors.png)
---
##  Type II error 

+ Difference not declared (i.e. $H_0$ not  rejected) when there is a difference (i.e. $H_0$ is false)
	+ Also known as a false negative
	+  $\beta$ = Pr (do not reject $H_0$ when $H_0$ is false)
	+ So, what does 1 − $\beta$ tell us?
1 − $\beta$ 	= Pr (reject $H_0$ when $H_0$ is false)
= Pr (a true positive)
+ This is the statistical power of the test!!

---
class: inverse

![](https://raw.githubusercontent.com/allisonhorst/stats-illustrations/master/other-stats-artwork/type_2_errors.png) 
---
##  Relationship between Type I and Type II errors 

+ Reducing the chance of a Type I error increases the chance of a Type II error
	+ They are inversely related
	+ Type II error rate is determined by a combination of:
		+ Size of difference (of biological significance) between the true population means
		+ Experimental error variance
		+ Sample size, and
		+ Choice of Type I error rate ($\alpha$)

---
class: inverse

## Power and significance

**Type I** error (false positive): declare a difference (i.e., reject $H_0$) when there is no difference (i.e. $H_0$ is true). Risk of the Type I error is determined by the *level of significance* (which we set!) (i.e., $\alpha =\text{ P(Type I error)} = \text{P(false positive)}$.

**Type II** error (false negative): difference not declared (i.e., $H_0$ not rejected) when there is a difference (i.e., $H_0$ is false). Let $\beta =$ P(do not reject $H_0$ when $H_0$ is false); so, $1-\beta$ = P(reject $H_0$ when $H_0$ is false) = P(a true positive), which is the statistical **power** of the test.

---
class: inverse

## Multiple comparisons

**Each** time we carry out a hypothesis test the probability we get a false positive result (type I error) is given by $\alpha$ (the *level of significance* we choose).

When we have **multiple comparisons** to make we should then control the **Type I** error rate across the entire *family* of tests under consideration, i.e., control the Family-Wise Error Rate (FWER); this ensures that the risk of making at least one **Type I** error among the family of comparisons in the experiment is $\alpha$.

---
#  Risks associated with hypothesis testing 



|State of Nature  | Don't reject $H_0$ | reject $H_0$ |
|---              |---                |---            |
| $H_0$ is true |  `r emo::ji("check")` | Type I error  |
| $H_0$ is false  | Type II error  | `r emo::ji("check")` |

---

### Simulate the situation

```{r t-test1, echo = FALSE}
set.seed(1314)
pop <- rnorm(1000, 5, 1)
sim <- data.frame(group = rep(c("A","B"), each = 10), 
                  val = c(sample(pop,10, replace = FALSE),
                          sample(pop,10, replace = FALSE)))
sim$y <- 0
ggplot(data = sim[sim$group == "A",], aes(x = val, y = y)) +
  geom_point() + ylim(0,0.3) + xlim(0,10) +
  theme_bw() + ylab("P(x)") +
  ggtitle("Sample from population A (n = 10)")
```

---

### Simulate the situation

```{r t-test2, echo = FALSE}
ma <- mean(sim[sim$group == "A","val"])
sa <- sd(sim[sim$group == "A","val"])
ggplot(data = sim[sim$group == "A",], aes(x = val, y = y)) +
  geom_point() + ylim(0,0.3) + xlim(0,10) +
  theme_bw() + ylab("P(x)") +
  ggtitle("Sample from population A (n = 10)") +
  geom_vline(xintercept = ma, lty = 2, alpha = 0.6, color = "grey") +
  annotate("text", x = ma, y = 0.15, parse = TRUE,
           label = "bar(x) *' = 6.02'") +
  annotate("text", x = ma, y = 0.1, parse = TRUE,
           label = "s[A] * ' = 1.02'")
```


---

### Simulate the situation

```{r t-test3, echo = FALSE}
mb <- mean(sim[sim$group == "B","val"])
sb <- sd(sim[sim$group == "B","val"])
ggplot(data = sim[sim$group == "A",], aes(x = val, y = y)) +
  geom_point() + ylim(0,0.3) + xlim(0,10) +
  theme_bw() + ylab("P(x)") +
  ggtitle("Sample from population B (n = 10)") + 
  theme(plot.title = element_text(color = "purple")) +
  geom_vline(xintercept = ma, lty = 2, alpha = 0.6, color = "grey") +
  annotate("text", x = ma, y = 0.15, parse = TRUE,
           label = "bar(x) *' = 6.02'") +
  annotate("text", x = ma, y = 0.1, parse = TRUE,
           label = "s[A] * ' = 1.02'") +
  geom_point(data = sim[sim$group == "B",], 
             aes(x = val, y = y),shape = 3, color = "purple") +
  geom_vline(xintercept = mb, lty = 2, alpha = 0.4, color = "purple") +
  annotate("text", x = mb, y = 0.15, parse = TRUE,
           label = "bar(x) *' = 4.79'", color = "purple") +
  annotate("text", x = mb, y = 0.1, parse = TRUE,
           label = "s[B] * ' = 0.77'",color = "purple") 
```

### Simulate the situation

```{r t-test4, echo = FALSE}
mb <- mean(sim[sim$group == "B","val"])
sb <- sd(sim[sim$group == "B","val"])
ggplot(data = sim[sim$group == "A",], aes(x = val, y = y)) +
  geom_point() + ylim(0,0.3) + xlim(0,10) +
  theme_bw() + ylab("P(x)") +
  geom_vline(xintercept = ma, lty = 2, alpha = 0.6, color = "grey") +
  annotate("text", x = ma, y = 0.15, parse = TRUE,
           label = "bar(x) *' = 6.02'") +
  annotate("text", x = ma, y = 0.1, parse = TRUE,
           label = "s[A] * ' = 1.02'") +
  geom_point(data = sim[sim$group == "B",], 
             aes(x = val, y = y),shape = 3, color = "purple") +
  geom_vline(xintercept = mb, lty = 2, alpha = 0.4, color = "purple") +
  annotate("text", x = mb, y = 0.15, parse = TRUE,
           label = "bar(x) *' = 4.79'", color = "purple") +
  annotate("text", x = mb, y = 0.1, parse = TRUE,
           label = "s[B] * ' = 0.77'",color = "purple") 
  
```

---

```{r t-test}
ggpubr::compare_means(val ~ group, data = sim, method = "t.test")
```

---


```{r between, echo = FALSE}
# plot
ggstatsplot::ggbetweenstats(
  data = sim,
  x = group,
  y = val,
  type = "r", # robust statistics 
  k = 3, # number of decimal places for statistical results
  xlab = "Group", # label for the x-axis variable
  ylab = "Value", # label for the y-axis variable
  title = "", # title text for the plot
  ggtheme = ggthemes::theme_fivethirtyeight(), # choosing a different theme
  ggstatsplot.layer = FALSE, # turn off `ggstatsplot` theme layer
  package = "wesanderson", # package from which color palette is to be taken
  palette = "Darjeeling1" # choosing a different color palette
)
```

---

class: inverse, center, middle

## p-value indicates we have evidence to reject the null hupothesis at the 0.1% level

--

## But the samples were taken from the **SAME** population

---
```{r t-test5, echo = FALSE}
ggplot(data = sim[sim$group == "A",], aes(x = val, y = y)) +
  geom_point() +  xlim(0,10) +
  theme_bw() + ylab("P(x)") +
  ggtitle("FALSE POSITIVE") +
  geom_vline(xintercept = ma, lty = 2, alpha = 0.6, color = "grey") +
  annotate("text", x = ma, y = 0.15, parse = TRUE,
           label = "bar(x) *' = 6.02'") +
  annotate("text", x = ma, y = 0.1, parse = TRUE,
           label = "s[A] * ' = 1.02'") +
  geom_point(data = sim[sim$group == "B",], 
             aes(x = val, y = y),shape = 3, color = "purple") +
  geom_vline(xintercept = mb, lty = 2, alpha = 0.4, color = "purple") +
  annotate("text", x = mb, y = 0.15, parse = TRUE,
           label = "bar(x) *' = 4.79'", color = "purple") +
  annotate("text", x = mb, y = 0.1, parse = TRUE,
           label = "s[B] * ' = 0.77'",color = "purple") +
  stat_function(fun = dnorm, n = 1000, args = list(mean = 5, sd = 1), 
                alpha = 0.5) +
  geom_vline(xintercept = 5) + annotate("text", x = 5.5, y = 0.25, parse = TRUE,
           label = "mu * '= 5'") 
  
```
---

### Pairwise comparison of 3 groups

What's the error rate in 1000 trials? i.e. How often is a difference wrongly declared?

```{r type 1}
pval <- matrix(numeric(3000), ncol = 3)
for (i in 1:nrow(pval)){
   sim <- data.frame(group = rep(c("A","B","C"), each = 10), 
                    val = c(sample(pop,10, replace = FALSE),
                            sample(pop,10, replace = FALSE),
                            sample(pop,10, replace = FALSE)))
   test01 <- t.test(val ~ group, data = sim[sim$group != "A",])$p.value
   test02 <- t.test(val ~ group, data = sim[sim$group != "B",])$p.value
   test03 <- t.test(val ~ group, data = sim[sim$group != "C",])$p.value
   pval[i,] <- c(test01,test02,test03)
}
```

---
```{r type 1vals}
p <- c(pval) <= 0.05 ## when do they fail?
prop.table(table(p))
p <- c(pval) <= 0.01 ## when do they fail?
prop.table(table(p))
p <- c(pval) <= 0.2 ## when do they fail?
prop.table(table(p))
```

---

## Probability of commiting no Type I errors

$(1 - \alpha)^m$ where $m$ is the number of independent tests

```{r typ1}
(1 - 0.05)^3
```

---

FWER = $\alpha_F$ $1 - (1 - \alpha)^m$ where $m$ is the number of independent tests

Probability of committing at least one Type I error

1 minus the probability of committing no Type I errors

```{r type1}
1 - (1 - 0.05)^3
```

---

PCER when $\alpha_F$ is fixed

We need to find the PCER when the FWER is $\alpha_F$

```{r typef}
1 - (1 - 0.05)^1/3
```

---

```{r alp, echo = FALSE}
m <- data.frame(m = rep(1:10,3))
m$alpha <- rep(c(0.01,0.05,0.2),each = 10)
m$fwer <- 1 - (1 - m$alpha)^m$m 
m$pcer <- 1 - (1 - m$alpha)^(1/m$m) 
require(patchwork)
p <- ggplot(data = m, aes(x = as.factor(m), y = pcer, 
                          color = as.factor(alpha), group = as.factor(alpha) )) +
  geom_point() + geom_line() + xlab("Number of comparisons, m") +
  labs(colour = "alpha") +
  ylab("Per comparison error rate") + 
  theme_classic() + geom_hline(yintercept = 0.0005) 
f <- ggplot(data = m, aes(x = as.factor(m), y = fwer, color = as.factor(alpha),
                          group = as.factor(alpha))) +
  geom_point()  + geom_line() + xlab("Number of comparisons, m") +
  ylab("Family wise comparison error rate") + 
  labs(colour = "alpha") +
  theme_classic()
f + p
```


---

### So what can we do?

+ Control the Type I error rate across the
entire “family” of tests u```{r type 1}nder consideration.
Familywise error rate

+ The risk of making at least one Type I error
among the family of comparisons in the
experiment

+ Also known as the *experimentwise* error
rate

---

### Familywise error rate (FWER)

• Suppose we conduct m independent t-tests
• Assume H 0 is true for all m tests
• For any single test, let...
Pr(commit a Type 1 error) = $\alpha$ C
– Known as the per comparison error rate (PCER)
• What’s the probability a correct decision is
made?
Pr(do not commit a Type 1 error) = 1 −  C
---
---
#  Familywise error rate (FWER) 

+ Probability of committing no Type I errors
(assuming m  independent  t -tests)
+ Probability of committing at least one Type I error
	+ 1 minus the probability of committing no Type I errors
+ denotes the upper limit of the FWER, i.e.
FWER ≤
+ We need to find the PCER when the FWER is

---
#  Familywise error rate (FWER) 

+ If we set FWER = , from previous slide:
(assuming m  independent  t -tests)
+ We need to make the subject in the above equation, i.e.

---
#  Familywise error rate (FWER) 

Why is  F the upper limit?
+ We assumed the tests are independent!
	+ Are the tests independent of one another?
	+ Consider again the CRD


---
#  Familywise error rate (FWER) 

Why is  F the upper limit?
+ There are three pairwise comparisons
	+ Null hypotheses:  P ‒  C = 0;  S  ‒  C  = 0;  P  ‒  S = 0
	+ What are the t -statistics for testing these null hypotheses?
	+ Let’s look at one of these, e.g. H 0 :  P ‒  C = 0
where is the SED of .

---
#  Familywise error rate (FWER) 

Why is  F the upper limit?
+ Consider the for the other hypothesis tests
	+ Do any of them share information?
		+ Some of the t -statistics share the same sample mean in their numerator; Sham vs Control, Sham vs Pancreatitis
		+ They all share the s 2 (from the ANOVA’s Residual MS)
	+ Let’s look at what happens to:
		+ the FWER,  F , when fix the PCER,  C ,  at 0.05, 0.01 and 0.10
		+ the PCER,  C  , when fix the FWER,  F ,  at 0.05, 0.01 and 0.10

---
#  F when C = 0.01, 0.05, 0.10  

Each test conducted with a PCER of  C = 0.01, 0.05 , 0.10 .
Risk of at least one Type I error escalates as  the number of tests increases.
![](assets/img/image37.emf)

---
#  C when F = 0.01, 0.05, 0.10  

Each test conducted with an FWER of  F = 0.01, 0.05 , 0.10 .
When we want to keep the risk of committing at least one Type I error fixed at  F = 0.05 , the PCER for m = 10 tests is 0.005 .
So what can we do?
![](assets/img/image38.emf)

---
#  Adjustments for multiple testing 

Fisher’s, Least Significant Difference, LSD
Bonferroni correction, i.e.
where = number of pairwise comparisons
Multiple comparison procedures
Tukey’s Honest Significant Difference (HSD)
Dunnett’s test
Lots more
False Discovery Rate (FDR)

---
#  Fisher’s LSD 

The idea:
Carry out post-hoc tests only if the ANOVA omnibus F -test is significant
Declare significant 100x α % any pairwise difference > LSD
Note: If α = 0.5, then 100 x α % = 5%
Does not control the FWER

---
#  Bonferroni correction 

We reject all null hypotheses for which the p-value
where
= FWER
= number of pairwise comparisons
Extremely general and simple , but often not powerful
It makes no assumptions about independence between tests
This means is invalid if this assumption is violated

---
#  Bonferroni inequality 

PCER,  C = 0.05 (Fisher’s LSD)
PCER,  B  =  C  /3 = 0.05/3 = 0.0167 ( Bonferroni correction)
Since we have only 3 means, and so only 3 comparisons division of PCER by 3
Does not change any of our conclusions – width of CI’s does not increase very much
.pull-left[![](assets/img/image39.png)]

.pull-right[![](assets/img/image41.png)]

---
#  Tukey’s Honest Significant Difference (HSD) 

+ Compares the mean of every treatment with the mean of every other treatment
	+ CRD example:
H 01 :  P −  c = 0
H 02 :  P −  S  = 0
H 03 :  S −  c  = 0
+ Uses Studentized range distribution, compared with t -distribution for Fisher’s LSD and Bonferroni correction:

---
#  Tukey’s Honest Significant Difference (HSD) 

+ Idea: If we pick out the tallest and shortest members of a class, they may appear to have significantly different heights, but in fact they are from the same population
	+ Somebody has to be the most extreme
	+ Tukey’s Honest Significant Difference (HSD ) adjusts for this
	+ Looks at the range, Biggest – Smallest, of a set of means
	+ Could these have come from the same underlying distribution?

---
#  Tukey’s Honest Significant Difference (HSD) 

+ Uses Tukey’s  Studentised Range
where m is the is -level critical value for m 	means.
$`Pairwise p-value`
C       P       S
C 0.0000 -0.8446 -5.3216
P 0.6863  0.0000 -4.4770
S 0.0012  0.0039  0.0000
"The matrix has t-value above the diagonal,
p-value (adjusted by ‘ tukey ’ method) below the diagonal"

---
#  Tukey’s Honest Significant Difference (HSD) 



---
#  Bonferroni vs Tukey’s HSD 

+ As the number of means, m, increases
	+ The number of pairs of means m(m-1)/2 = increases very rapidly
	+ Tukey’s HSD does not increase so rapidly
	+ Suppose SED = 1, PCER a = 0.05

```{r tbl89, echo = FALSE}
tbl89 <- tibble::tribble(
~`m`, ~`Comparisons`, ~`Bonferroni`, ~`Tukey HSD`,
"2","1","1.96","1.96",
"3","3","2.39","2.35",
"5","10","2.81","2.73",
"10","45","3.26","3.17"
)

kableExtra::kable_styling(knitr::kable(tbl89), font_size = 18)
```

---


## PDQR R-function

![](https://raw.githubusercontent.com/cmjt/statbiscuits/master/figs_n_gifs/pdqr.png)


---



